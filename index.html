<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NovaSeek</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg: #ffffff;
            --surface: #ffffff;
            --muted: #6b7278;
            --text: #0b0d10;
            --brand: #4285f4;
            --accent: #5985E1;
            --shadow: rgba(0,0,0,0.08);
            --card-border: #e6e7e8;
            --chip-bg: #fff;
            --chip-border: #e6e7e8;
            --radius-lg: 14px;
            --radius-pill: 999px;
            --glass: rgba(255,255,255,0.85);
            --glass-dark: rgba(0,0,0,0.5);
            --success: #34a853;
            --danger: #ea4335;
            --transition: 200ms ease;
            --max-width: 980px;
            --search-height: 56px;
            --card-padding: 16px;
        }
        body.dark{
            --bg: #0b0c10;
            --surface: #111215;
            --muted: #b0b3b6;
            --text: #eef0f2;
            --chip-bg: #111215;
            --chip-border: #26282b;
            --card-border: #222428;
            --glass: rgba(10,10,12,0.7);
        }
        *{ box-sizing:border-box }
        html,body{ height:100% }
        body{
            margin:0;
            padding:0;
            font-family: "Roboto", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background:var(--bg);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            display:flex;
            flex-direction:column;
            align-items:center;
            transition: background var(--transition), color var(--transition);
        }
        .header {
            position: relative; 
            width:100%;
            max-width:var(--max-width);
            padding:16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }
        .brand {
            display:flex;
            gap:12px;
            align-items:center;
        }
        .brand .dot {
            width:14px;
            height:14px;
            border-radius:50%;
            background: linear-gradient(135deg,var(--brand),#8ab4f8);
            box-shadow:0 0 12px rgba(66,133,244,0.18);
        }
        .brand .logo {
            font-family:'Orbitron',sans-serif;
            font-weight:700;
            font-size:22px;
            letter-spacing:.06em;
            background: linear-gradient(90deg,#8ab4f8,#a0c3ff);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .user-badge{
            min-width:44px;
            height:44px;
            border-radius:50%;
            display:grid;
            place-items:center;
            font-weight:700;
            color:var(--chip-bg);
            background: linear-gradient(135deg,var(--brand),#5a8ef6);
            box-shadow:0 6px 18px rgba(90,142,246,0.12);
            cursor: pointer;
        }
        .icon-btn{
            width:44px;
            height:44px;
            border-radius:50%;
            border:1px solid var(--card-border);
            background:var(--chip-bg);
            display:grid;
            place-items:center;
            cursor:pointer;
            transition: transform .06s, background var(--transition), border-color var(--transition);
        }
        .icon-btn:hover{ transform:scale(.98); }
        .container{
            width:100%;
            max-width:var(--max-width);
            padding:0 16px 80px 16px;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:18px;
        }
        .hero {
            margin-top:6vh;
            text-align:center;
        }
        .wordmark{
            font-family:'Orbitron',sans-serif;
            font-weight:700;
            font-size:48px;
            background: linear-gradient(90deg,#8ab4f8,#a0c3ff);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            letter-spacing:.06em;
            margin-bottom:6px;
        }
        .subtitle{
            color:var(--muted);
            font-size:14px;
            margin-top:4px;
        }
        .search-wrap{
            width:100%;
            max-width:720px;
            display:flex;
            flex-direction:column;
            gap:8px;
            align-items:center;
        }
        .search{
            width:100%;
            display:flex;
            gap:10px;
            align-items:center;
            padding:10px;
            border-radius:999px;
            background:var(--surface);
            border:1px solid var(--card-border);
            box-shadow:0 6px 18px var(--shadow);
            transition: box-shadow .18s, border-color .18s, background .2s;
            height:var(--search-height);
            position:relative;
        }
        .ai-suggest {
            position:absolute;
            top:calc(var(--search-height) + 8px);
            left:0;
            width:100%;
            max-height:260px;
            overflow:auto;
            border-radius:12px;
            background:var(--surface);
            border:1px solid var(--card-border);
            box-shadow:0 10px 30px rgba(0,0,0,0.08);
            z-index:1200;
            display:none;
        }
        .ai-suggest.visible{ display:block; }
        
        /* 用戶下拉選單 CSS */
        #userDropdown {
            position: absolute;
            top: 60px; 
            right: 16px; 
            width: 240px;
            background: var(--surface);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            z-index: 1500;
            padding: 8px 0;
            display: none; 
        }
        #userDropdown.visible { display: block; }
        #userDropdown .info { padding: 8px 12px; font-size: 14px; border-bottom: 1px solid var(--card-border); margin-bottom: 4px; }
        #userDropdown .info strong { display: block; font-weight: 700; }
        #userDropdown .info span { color: var(--muted); font-size: 12px; }
        #userDropdown button {
            width: 100%;
            padding: 10px 12px;
            text-align: left;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text);
            font-size: 14px;
        }
        #userDropdown button:hover { background: rgba(66,133,244,0.06); }

        /* 帳戶管理彈出視窗 CSS */
        #accountModal, #backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: none;
            place-items: center;
        }
        #backdrop {
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        #accountModal.visible, #backdrop.visible { display: grid; }
        .modal-content {
            background: var(--surface);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.3);
            transition: background var(--transition);
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content label { display: block; margin-top: 12px; font-size: 14px; color: var(--muted); }
        .modal-content input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--card-border); 
            border-radius: 8px; 
            margin-top: 4px;
            background: var(--chip-bg);
            color: var(--text);
        }
        .modal-actions { margin-top: 24px; text-align: right; }
        .modal-actions button { margin-left: 8px; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 500;}
        .modal-actions .btn-save { background: var(--brand); color: white; border: none; }
        .modal-actions .btn-cancel { background: var(--chip-bg); border: 1px solid var(--card-border); color: var(--text); }
        
        /* 原始 CSS 略 */
        .search:focus-within{ box-shadow:0 12px 36px rgba(0,0,0,0.08); border-color:rgba(0,0,0,0.06); }
        .search input[type="text"]{
            flex:1;
            border:0;
            outline:0;
            background:transparent;
            color:var(--text);
            font-size:16px;
            padding:8px 6px;
        }
        .chips{
            width:100%;
            max-width:720px;
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            justify-content:center;
            padding:6px 6px;
        }
        .chips .chip{
            padding:8px 12px;
            border-radius:999px;
            background:var(--chip-bg);
            border:1px solid var(--chip-border);
            cursor:pointer;
            transition: background .15s, transform .08s;
            color:var(--text);
            font-size:14px;
        }
        .chips .chip:hover{ background:rgba(66,133,244,0.06); transform:translateY(-1px); }
        .results{
            width:100%;
            max-width:720px;
            display:flex;
            flex-direction:column;
            gap:16px;
            margin-top:6px;
            align-items:stretch;
        }
        .side-panel{
            width:320px;
            display:flex;
            flex-direction:column;
            gap:12px;
        }
        .panel {
            padding:12px;
            border-radius:12px;
            background:var(--surface);
            border:1px solid var(--card-border);
            box-shadow:0 8px 28px rgba(0,0,0,0.06);
        }
        .panel h4{ margin:0 0 8px 0; font-size:16px; color:var(--text); }
        .list .row{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px; border-radius:10px; cursor:pointer; transition: background .12s; background:transparent; }
        .list .row:hover{ background:rgba(66,133,244,0.06); }
        .list .rank{ width:28px; height:28px; border-radius:50%; display:grid; place-items:center; background:var(--chip-bg); border:1px solid var(--card-border); }
        .footer {
            position:fixed;
            left:12px;
            bottom:10px;
            z-index:20;
            font-size:13px;
            color:var(--muted);
            background:var(--glass);
            padding:6px 10px;
            border-radius:10px;
            border:1px solid var(--card-border);
        }
        @media (max-width:860px){
            .cols{ grid-template-columns: 1fr; gap:12px; }
            .side-panel{ width:100%; }
        }
        @media (max-width:520px){
            .wordmark{ font-size:36px; }
        }
    </style>
</head>
<body>
<script src="./searchTerms.js"></script>
<script>
    const params = new URLSearchParams(window.location.search);
    if (params.get('hl') !== 'tw') {
        if (window.location.pathname === '/') {
            params.set('hl', 'tw');
            window.location.replace('/?' + params.toString());
        }
    }
</script>
<header class="header" role="banner">
    <div class="brand" aria-hidden="false">
        <div class="dot" aria-hidden="true"></div>
        <div class="logo">NovaSeek</div>
    </div>
    <div id="authArea" aria-live="polite">
        </div>
    <div id="userDropdown" role="menu" aria-hidden="true"></div> 
</header>
<div id="backdrop" aria-hidden="true"></div> 
<div id="accountModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true"></div>

<main class="container" role="main">
    <section class="hero" aria-labelledby="hero-title">
        <h1 id="hero-title" class="wordmark">NovaSeek</h1>
        <div class="subtitle">智能搜尋‑AI 建議、你的收藏與統計</div>
    </section>
    <section class="search-wrap" aria-label="搜尋區">
        <div class="search" id="searchBox">
            <input id="searchInput" type="text" placeholder="在 NovaSeek 上搜尋（按 Enter 或點按放大鏡）" autocomplete="off" aria-label="搜尋輸入" />
            <button class="icon-btn" id="btnSearch" title="搜尋" aria-label="搜尋按鈕">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#5985E1"><path d="M765-144 526-383q-30 22-65.79 34.5-35.79 12.5-76.18 12.5Q284-336 214-406t-70-170q0-100 70-170t170-70q100 0 170 70t70 170.03q0 40.39-12.5 76.18Q599-464 577-434l239 239-51 51ZM384-408q70 0 119-49t49-119q0-70-49-119t-119-49q-70 0-119 49t-49 119q0 70 49 119t119 49Z"/></svg>
            </button>
            <button class="icon-btn" id="btnMic" title="語音搜尋" aria-label="語音搜尋">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#5985E1"><path d="M480-384q-50 0-85-35t-35-85v-240q0-50 35-85t85-35q50 0 85 35t35 85v240q0 50-35 85t-85 35Zm0-240Zm-36 480v-99q-98.8-13.1-163.4-87.05Q216-404 216-504h72q0 79.68 56.23 135.84 56.22 56.16 136 56.16Q560-312 616-368.16q56-56.16 56-135.84h72q0 100-64.6 173.95Q614.8-256.1 516-243v99h-72Zm36-312q20.4 0 34.2-13.8Q528-483.6 528-504v-240q0-20.4-13.8-34.2Q500.4-792 480-792q-20.4 0-34.2 13.8Q432-764.4 432-744v240q0 20.4 13.8 34.2Q459.6-456 480-456Z"/></svg>
            </button>
            <div class="ai-suggest" id="aiSuggest" role="listbox" aria-label="建議清單"></div>
        </div>
        <div class="chips" id="chips" role="list" aria-label="熱門或建議關鍵字"></div>
    </section>
    <div class="cols" style="width:100%;max-width:var(--max-width);display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:6px;">
        <div>
            <div class="results" id="results" role="region" aria-live="polite" aria-label="搜尋結果"></div>
        </div>
        <aside class="side-panel" aria-label="側邊功能">
            <div class="panel" id="panelTrending" aria-live="polite">
                <h4>熱門搜尋</h4>
                <div class="list" id="trendingList" role="list"></div>
            </div>
            <div class="panel" id="panelRecent" aria-live="polite">
                <h4>你的最近搜尋</h4>
                <div class="list" id="recentList" role="list"></div>
            </div>
        </aside>
    </div>
</main>
<div class="footer" aria-hidden="false">Copyright © 2025 NovaSeek 保留一切權利。</div>
<button id="modeBtn" title="切換深淺模式" aria-pressed="false" style="position:fixed;right:20px;bottom:20px;z-index:1200;padding:10px 15px;border-radius:12px;border:1px solid var(--card-border);background:var(--surface);color:var(--text);cursor:pointer;font-weight:500;">自訂 NovaSeek</button>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
    // ----------------------------------------------------
    // Firebase & 環境設定
    // ----------------------------------------------------
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyA7K4x1Di_xUaVt7MF08LfumJxc10dqa3c",
        authDomain: "sample-firebase-ai-app-df21b.firebaseapp.com",
        projectId: "sample-firebase-ai-app-df21b",
        storageBucket: "sample-firebase-ai-app-df21b",
        messagingSenderId: "762970139210",
        appId: "1:762970139210:web:149e9ab5e9593a484cd4b3"
    };
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 實際的認證提供者：使用 Google 登入來替代虛擬的 novaseek 登入
    const provider = new firebase.auth.GoogleAuthProvider(); 

    // ----------------------------------------------------
    // DOM 元素與狀態 (略)
    // ----------------------------------------------------
    const authArea = document.getElementById('authArea');
    const userDropdown = document.getElementById('userDropdown');
    const accountModal = document.getElementById('accountModal');
    const backdrop = document.getElementById('backdrop');
    const searchInput = document.getElementById('searchInput');
    const btnSearch = document.getElementById('btnSearch');
    const btnMic = document.getElementById('btnMic');
    const aiSuggest = document.getElementById('aiSuggest');
    const chipsDiv = document.getElementById('chips');
    const resultsDiv = document.getElementById('results');
    const trendingList = document.getElementById('trendingList');
    const recentList = document.getElementById('recentList');
    const modeBtn = document.getElementById('modeBtn');

    let currentUser = null;
    let localTrendingCounts = {}; 
    let currentSuggestList = [];
    let selectedSuggestIndex = -1;

    // ----------------------------------------------------
    // 工具函數 (略)
    // ----------------------------------------------------
    function escapeHtml(str){
        if(!str) return '';
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#39;');
    }

    function timeAgo(timestamp){
        if(!timestamp) return '';
        const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
        let interval = Math.floor(seconds / 31536000);
        if(interval >= 1) return interval + ' 年前';
        interval = Math.floor(seconds / 2592000);
        if(interval >= 1) return interval + ' 個月前';
        interval = Math.floor(seconds / 86400);
        if(interval >= 1) return interval + ' 天前';
        interval = Math.floor(seconds / 3600);
        if(interval >= 1) return interval + ' 小時前';
        interval = Math.floor(seconds / 60);
        if(interval >= 1) return interval + ' 分鐘前';
        return '剛剛';
    }
    
    // ----------------------------------------------------
    // 登入、登出與帳戶管理 (實際 Firebase 呼叫)
    // ----------------------------------------------------

    function toggleDropdown(show) {
        userDropdown.classList.toggle('visible', show);
        userDropdown.setAttribute('aria-hidden', !show);
    }

    // *** 新增：實際觸發 Firebase 登入重定向的函數 ***
    function handleLogin() {
        // 實際的 Firebase 登入流程：使用重定向 (Redirect)
        // 這會將使用者導向 Google 登入頁面
        auth.signInWithRedirect(provider)
        .catch(error => {
            console.error("Redirect login start failed:", error);
            alert("登入開始失敗：" + error.message);
        });
    }

    // *** 修改：實際觸發 Firebase 登出的函數 ***
    async function handleLogout() {
        try {
             await auth.signOut();
             // onAuthStateChanged 會自動更新 UI
             toggleDropdown(false);
        } catch (error) {
            console.error("登出失敗:", error);
            alert("登出失敗：" + error.message);
        }
    }
    
    // 帳戶修改功能 (在純前端環境中為模擬功能)
    function showAccountModal() {
        // 保持不變，因為 Firebase 帳戶資訊修改涉及敏感操作，需要 Re-authentication
        // 我們這裡只保留前端 UI 流程
        backdrop.classList.add('visible');
        accountModal.classList.add('visible');
        accountModal.setAttribute('aria-hidden', 'false');

        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.innerHTML = `
            <h3 id="modalTitle">帳戶設定 - 董事長專區</h3>
            <label for="modalName">使用者名稱</label>
            <input id="modalName" type="text" value="${escapeHtml(currentUser.displayName || '')}" placeholder="請輸入新的名稱" />
            
            <label for="modalEmail">電子郵件 (不可修改)</label>
            <input id="modalEmail" type="email" value="${escapeHtml(currentUser.email || '')}" disabled />
            
            <label for="modalPassword">修改密碼 (留空則不修改)</label>
            <input id="modalPassword" type="password" placeholder="請輸入新的密碼" />
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideAccountModal()">取消</button>
                <button class="btn-save" onclick="saveAccountChanges()">儲存</button>
            </div>
        `;
        accountModal.innerHTML = '';
        accountModal.appendChild(modalContent);
        toggleDropdown(false); 
    }

    function hideAccountModal() {
        backdrop.classList.remove('visible');
        accountModal.classList.remove('visible');
        accountModal.setAttribute('aria-hidden', 'true');
    }

    function saveAccountChanges() {
        const newName = document.getElementById('modalName').value.trim();
        const newPassword = document.getElementById('modalPassword').value.trim();

        if (newName && newName !== currentUser.displayName) {
            // 實際應呼叫 user.updateProfile({ displayName: newName })
            currentUser.displayName = newName;
        }
        if (newPassword) {
            // 實際應呼叫 user.updatePassword(newPassword) 並處理 Re-authentication
            alert(`密碼已模擬更新！(實際操作需 Re-authentication)`);
        }

        localStorage.setItem('novaseek_user', JSON.stringify(currentUser));
        renderAuthUI();
        hideAccountModal();
        alert("您的資訊已成功儲存。");
    }

    function renderAuthUI(){
        authArea.innerHTML = '';
        userDropdown.innerHTML = ''; 

        if(currentUser){
            // 1. 渲染頭像徽章
            const badge = document.createElement('div');
            badge.className = 'user-badge';
            badge.id = 'userBadge'; 
            const displayLetter = (currentUser.displayName && currentUser.displayName[0]) ? currentUser.displayName[0].toUpperCase() : (currentUser.email?currentUser.email[0].toUpperCase():'U');
            badge.textContent = displayLetter;
            badge.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleDropdown(!userDropdown.classList.contains('visible'));
            });
            authArea.appendChild(badge);

            // 2. 渲染下拉選單內容
            userDropdown.innerHTML = `
                <div class="info">
                    <strong>${escapeHtml(currentUser.displayName || '未設定名稱')}</strong>
                    <span>${escapeHtml(currentUser.email)}</span>
                </div>
                <button onclick="showAccountModal()" role="menuitem">個人資料與設定</button>
                <button onclick="handleLogout()" role="menuitem">登出</button>
            `;

        } else {
            // 渲染登入按鈕
            const btn = document.createElement('button');
            btn.id = 'authBtn2';
            btn.textContent = '登入';
            btn.className = 'icon-btn';
            btn.style.width = 'auto';
            btn.style.borderRadius = '12px';
            btn.style.padding = '8px 12px';
            // *** 使用新的 handleLogin 函數 ***
            btn.addEventListener('click', handleLogin); 
            authArea.appendChild(btn);
        }
        updateRecentListUI();
    }
    
    // ----------------------------------------------------
    // 實際的 Firebase 狀態管理 (替換舊的 setupAuthStateListener)
    // ----------------------------------------------------

    // 1. 處理重定向回來的結果
    async function handleRedirectResult() {
        try {
            // 嘗試獲取重定向結果。這是登入資訊安全回傳的機制。
            const result = await auth.getRedirectResult();
            if (result.user) {
                console.log("成功從重定向獲取登入結果:", result.user.uid);
                // 成功登入後，onAuthStateChanged 會在稍後處理狀態更新。
                
                // 清理 URL 參數（移除 Firebase 登入後產生的 hash 或 query 參數）
                if (window.history.replaceState) {
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({path:cleanUrl},'',cleanUrl);
                }
            }
        } catch (error) {
            // 處理重定向時發生的錯誤
            console.error("重定向登入處理失敗:", error);
            alert("登入處理失敗：" + error.message);
        }
    }

    // 2. 監聽全域登入狀態 (最可靠的方式，當狀態改變時會被觸發)
    function setupRealtimeAuthStateListener() {
        auth.onAuthStateChanged(user => {
            if (user) {
                // 使用者已登入。使用 Firebase 提供的最新 user 物件。
                currentUser = {
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0], 
                    uid: user.uid
                };
                // 將資訊快取到 localStorage
                localStorage.setItem('novaseek_user', JSON.stringify(currentUser));
            } else {
                // 使用者已登出
                currentUser = null;
                localStorage.removeItem('novaseek_user');
            }
            renderAuthUI();
        });
    }


    // ----------------------------------------------------
    // AI 建議邏輯 (略)
    // ----------------------------------------------------
    function generateLocalAISuggestions(query){
        if(!query) return [];
        const base = query.trim();
        return [
            `${base} 是什麼`,
            `${base} 關於`,
            `${base} 教學`,
            `最新 ${base} 資訊`,
            `${base} 下載`,
            `${base} 免費資源`,
            `${base} vs 競品`,
            `${base} 好用嗎`,
            `${base} 範例`
        ];
    }

    async function fetchAIFromAPI(query){
        if (typeof GLOBAL_KNOWLEDGE_BASE === 'undefined') return [];
        
        const searchPrefix = query.trim().toLowerCase();
        if (searchPrefix.length < 1) return [];

        const scores = new Map(); 
        const MAX_RESULTS = 10;
        
        // 1. 靜態知識庫加權
        GLOBAL_KNOWLEDGE_BASE.forEach(item => {
            const lowerTerm = item.term.toLowerCase();
            if (lowerTerm.startsWith(searchPrefix)) {
                scores.set(item.term, (scores.get(item.term) || 0) + item.weight * 1.5); 
            }
        });

        // 2. 動態熱門度加權 (localTrendingCounts)
        Object.entries(localTrendingCounts).forEach(([term, count]) => {
            const lowerTerm = term.toLowerCase();
            if (lowerTerm.startsWith(searchPrefix)) {
                const trendScore = Math.min(count * 20, 100); 
                scores.set(term, (scores.get(term) || 0) + trendScore);
            }
        });
        
        // 3. 個人化歷史紀錄加權
        const localRecent = JSON.parse(localStorage.getItem('novaseek_local_searches') || '[]');
        const uniqueRecent = [...new Map(localRecent.map(item => [item.q, item])).values()]; 
        uniqueRecent.slice(0, 20).forEach((item, index) => { 
            const term = item.q;
            const lowerTerm = term.toLowerCase();
            if (lowerTerm.startsWith(searchPrefix)) {
                const personalScore = (20 - index) * 2;
                scores.set(term, (scores.get(term) || 0) + personalScore);
            }
        });
        
        // 4. 基礎模板補充
        let suggestions = Array.from(scores.keys());
        if (suggestions.length < MAX_RESULTS) {
            const localTemplates = generateLocalAISuggestions(query);
            localTemplates.forEach(t => {
                const lowerT = t.toLowerCase();
                if (lowerT.startsWith(searchPrefix)) {
                    if (suggestions.length < MAX_RESULTS && !scores.has(t)) {
                        scores.set(t, (scores.get(t) || 0) + 50); 
                        suggestions.push(t);
                    }
                }
            });
        }

        // 5. 排序與篩選
        const finalSuggestions = Array.from(scores.entries())
            .sort(([, scoreA], [, scoreB]) => scoreB - scoreA) 
            .map(([term]) => term)
            .slice(0, MAX_RESULTS);

        return finalSuggestions;
    }

    function renderAISuggestions(suggestions){
        currentSuggestList = suggestions || [];
        selectedSuggestIndex = -1;
        aiSuggest.innerHTML = '';
        if(!suggestions || suggestions.length === 0){
            aiSuggest.classList.remove('visible');
            aiSuggest.style.display = 'none';
            return;
        }
        const ul = document.createElement('ul');
        suggestions.forEach((s, idx) => {
            const li = document.createElement('li');
            li.setAttribute('role','option');
            li.setAttribute('aria-selected','false');
            li.tabIndex = 0;
            li.innerHTML = escapeHtml(s);
            li.addEventListener('mouseenter', ()=> { selectedSuggestIndex = idx; updateSuggestHighlight(); });
            li.addEventListener('mouseleave', ()=> { selectedSuggestIndex = -1; updateSuggestHighlight(); });
            li.addEventListener('click', ()=> { selectSuggestion(idx); });
            ul.appendChild(li);
        });
        aiSuggest.appendChild(ul);
        aiSuggest.classList.add('visible');
        aiSuggest.style.display = 'block';
    }

    function updateSuggestHighlight(){
        const lis = aiSuggest.querySelectorAll('li');
        lis.forEach((li, i) => {
            if(i === selectedSuggestIndex){
                li.style.background = 'rgba(66,133,244,0.06)';
                li.setAttribute('aria-selected','true');
            } else {
                li.style.background = 'transparent';
                li.setAttribute('aria-selected','false');
            }
        });
    }

    function selectSuggestion(idx){
        const s = currentSuggestList[idx];
        if(!s) return;
        searchInput.value = s;
        redirectToSearch(s);
        aiSuggest.classList.remove('visible');
        aiSuggest.style.display = 'none';
    }

    // ----------------------------------------------------
    // 語音搜尋邏輯 (略)
    // ----------------------------------------------------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    function startVoiceSearch() {
        if (!SpeechRecognition) {
            alert('抱歉，您的瀏覽器目前不支援語音搜尋功能。建議使用 Chrome 或 Edge。');
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-Hant'; 
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        btnMic.style.borderColor = 'var(--brand)';
        btnMic.style.boxShadow = '0 0 10px rgba(66, 133, 244, 0.4)';
        btnMic.style.background = 'rgba(66, 133, 244, 0.1)';
        btnMic.title = '正在聽取語音... 點擊停止';
        btnMic.querySelector('svg').style.fill = 'var(--brand)';

        recognition.onresult = function(event) {
            const speechResult = event.results[0][0].transcript;
            searchInput.value = speechResult;
            redirectToSearch(speechResult);
        };

        recognition.onend = function() {
            btnMic.style.borderColor = 'var(--card-border)';
            btnMic.style.boxShadow = 'none';
            btnMic.style.background = 'var(--chip-bg)';
            btnMic.title = '語音搜尋';
            btnMic.querySelector('svg').style.fill = 'var(--accent)';
        };

        recognition.onerror = function(event) {
            btnMic.style.borderColor = 'var(--danger)'; 
            btnMic.title = '辨識失敗';
            btnMic.querySelector('svg').style.fill = 'var(--danger)';
            setTimeout(recognition.onend, 1500); 
        };

        try {
            recognition.start();
        } catch (e) {
            recognition.onend();
        }
    }
    btnMic.addEventListener('click', startVoiceSearch);

    // ----------------------------------------------------
    // 搜尋與數據記錄 (略)
    // ----------------------------------------------------
    function redirectToSearch(q){
        if(!q || !q.trim()) return;
        const query = q.trim();
        recordSearch(query).catch(err => console.warn('recordSearch error', err));
        const searchUrl = `https://search.novaseek.org/?q=${encodeURIComponent(query)}`;
        resultsDiv.innerHTML = `<div class="result-card" style="justify-content:center;align-items:center;min-height:80px;"><div style="color:var(--muted)">正在導向 NovaSeek 官方搜尋頁面…</div></div>`;
        window.location.href = searchUrl;
    }

    async function recordSearch(query){
        try{
            // 寫入 novaseek_local_searches (本地紀錄)
            const localList = JSON.parse(localStorage.getItem('novaseek_local_searches') || '[]');
            localList.unshift({ q: query, ts: Date.now() });
            localList.splice(200);
            localStorage.setItem('novaseek_local_searches', JSON.stringify(localList));
        }catch(e){
            // console.warn('local save fail', e);
        }
        if(currentUser && currentUser.email){
            try{
                // 寫入 Firestore (遠端紀錄)
                const docRef = db.collection('searchRecords').doc();
                await docRef.set({
                    q: query,
                    uid: currentUser.email,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
            }catch(e){
                // console.error('Firestore record fail', e);
            }
        }
        updateTrendingCounts(query);
    }

    async function updateTrendingCounts(query){
        query = query.toLowerCase().trim();
        if(localTrendingCounts[query]){
            localTrendingCounts[query] += 1;
        } else {
            localTrendingCounts[query] = 1;
        }
        updateTrendingUI();
    }

    function updateTrendingUI(){
        trendingList.innerHTML = '';
        const localTrends = Object.entries(localTrendingCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
        localTrends.forEach(([q, count], index) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.setAttribute('role','listitem');
            row.addEventListener('click', ()=> redirectToSearch(q));
            const rank = document.createElement('div');
            rank.className = 'rank';
            rank.textContent = index + 1;
            const qText = document.createElement('div');
            qText.style.flex = 1;
            qText.textContent = escapeHtml(q);
            const countText = document.createElement('div');
            countText.style.fontSize = '12px';
            countText.style.color = 'var(--muted)';
            countText.textContent = `${count} 次`;
            row.appendChild(rank);
            row.appendChild(qText);
            row.appendChild(countText);
            trendingList.appendChild(row);
        });
        if(localTrends.length === 0){
            trendingList.innerHTML = `<div style="padding:10px;font-size:14px;color:var(--muted);">目前沒有熱門搜尋。</div>`;
        }
    }
    
    function updateRecentListUI(){
        recentList.innerHTML = '';
        const localRecent = JSON.parse(localStorage.getItem('novaseek_local_searches') || '[]');
        const uniqueRecent = [...new Map(localRecent.map(item => [item.q, item])).values()].slice(0, 5);
        uniqueRecent.forEach(({ q, ts }, index) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.setAttribute('role','listitem');
            row.addEventListener('click', ()=> redirectToSearch(q));
            const qText = document.createElement('div');
            qText.style.flex = 1;
            qText.textContent = escapeHtml(q);
            const timeText = document.createElement('div');
            timeText.style.fontSize = '12px';
            timeText.style.color = 'var(--muted)';
            timeText.textContent = timeAgo(ts);
            row.appendChild(qText);
            row.appendChild(timeText);
            recentList.appendChild(row);
        });
        if(uniqueRecent.length === 0){
            recentList.innerHTML = `<div style="padding:10px;font-size:14px;color:var(--muted);">開始搜尋以查看你的紀錄。</div>`;
        }
    }

    function renderInitialChips(){
        if (typeof INITIAL_KEYWORDS === 'undefined') return;
        
        chipsDiv.innerHTML = '';
        INITIAL_KEYWORDS.forEach(keyword => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = keyword;
            chip.addEventListener('click', ()=> redirectToSearch(keyword));
            chipsDiv.appendChild(chip);
        });
    }

    function toggleDarkMode(){
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem('novaseek_mode', isDark ? 'dark' : 'light');
        modeBtn.setAttribute('aria-pressed', isDark);
        modeBtn.textContent = isDark ? '切換亮色模式' : '切換深色模式';
    }

    function loadModePreference(){
        const savedMode = localStorage.getItem('novaseek_mode');
        if(savedMode === 'dark'){
            document.body.classList.add('dark');
            modeBtn.setAttribute('aria-pressed', 'true');
            modeBtn.textContent = '切換亮色模式';
        } else {
            modeBtn.textContent = '切換深色模式';
        }
    }
    modeBtn.addEventListener('click', toggleDarkMode);

    function handleSearch(){
        const query = searchInput.value.trim();
        if(!query) return;
        aiSuggest.classList.remove('visible');
        aiSuggest.style.display = 'none';
        redirectToSearch(query);
    }
    btnSearch.addEventListener('click', handleSearch);

    // ----------------------------------------------------
    // 事件監聽與鍵盤導航 (略)
    // ----------------------------------------------------
    let suggestTimer = null;
    searchInput.addEventListener('input', (e) => {
        const v = e.target.value.trim();
        if(suggestTimer) clearTimeout(suggestTimer);
        if(!v){
            aiSuggest.classList.remove('visible');
            aiSuggest.style.display = 'none';
            currentSuggestList = [];
            selectedSuggestIndex = -1;
            return;
        }
        
        suggestTimer = setTimeout(async () => {
            const suggestions = await fetchAIFromAPI(v); 
            renderAISuggestions(suggestions);
        }, 120);
    });

    searchInput.addEventListener('keydown', (e) => {
        if(!currentSuggestList.length && e.key !== 'Enter') return;

        if(e.key === 'ArrowDown'){
            e.preventDefault();
            selectedSuggestIndex = (selectedSuggestIndex + 1) % currentSuggestList.length;
            updateSuggestHighlight();
            if(selectedSuggestIndex !== -1 && aiSuggest.querySelectorAll('li')[selectedSuggestIndex]) {
                searchInput.value = currentSuggestList[selectedSuggestIndex];
            }
        } else if(e.key === 'ArrowUp'){
            e.preventDefault();
            selectedSuggestIndex = (selectedSuggestIndex - 1 + currentSuggestList.length) % currentSuggestList.length;
            updateSuggestHighlight();
            if(selectedSuggestIndex !== -1 && aiSuggest.querySelectorAll('li')[selectedSuggestIndex]) {
                searchInput.value = currentSuggestList[selectedSuggestIndex];
            }
        } else if(e.key === 'Enter'){
            e.preventDefault();
            if(selectedSuggestIndex >= 0) {
                selectSuggestion(selectedSuggestIndex);
            } else {
                handleSearch();
            }
        } else if(e.key === 'Escape'){
            e.preventDefault();
            aiSuggest.classList.remove('visible');
            aiSuggest.style.display = 'none';
            selectedSuggestIndex = -1;
        }
    });

    // 關閉下拉選單和模態視窗的通用處理
    document.addEventListener('click', (e) => {
        // 點擊區域外部時關閉下拉選單
        if (userDropdown.classList.contains('visible') && !authArea.contains(e.target) && !userDropdown.contains(e.target)) {
            toggleDropdown(false);
        }
        // 點擊遮罩時關閉模態視窗
        if (e.target === backdrop) {
            hideAccountModal();
        }
    });

    // ESC 鍵關閉模態視窗或下拉選單
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (accountModal.classList.contains('visible')) {
                hideAccountModal();
            } else if (userDropdown.classList.contains('visible')) {
                toggleDropdown(false);
            }
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadModePreference();

        // 1. 處理重定向結果 (這必須在狀態監聽之前或同時執行)
        handleRedirectResult(); 

        // 2. 啟動狀態監聽 (這是狀態的主體)
        setupRealtimeAuthStateListener();

        renderInitialChips(); 
        updateTrendingUI();
    });
</script>
</body>
</html>